<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administracyjny | Projekt NeuroBioMyko</title>
    <link rel="stylesheet" th:href="@{/css/badania.css}">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&family=Exo+2:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body class="archivum-body">

<main class="container archivum-content">
    <section class="cyber-panel">
        <div class="panel-header">
            <div class="panel-icon">
                <svg viewBox="0 0 24 24" width="24" height="24">
                    <path fill="currentColor" d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M12,10.5A1.5,1.5 0 0,1 13.5,12A1.5,1.5 0 0,1 12,13.5A1.5,1.5 0 0,1 10.5,12A1.5,1.5 0 0,1 12,10.5M7.5,10.5A1.5,1.5 0 0,1 9,12A1.5,1.5 0 0,1 7.5,13.5A1.5,1.5 0 0,1 6,12A1.5,1.5 0 0,1 7.5,10.5M16.5,10.5A1.5,1.5 0 0,1 18,12A1.5,1.5 0 0,1 16.5,13.5A1.5,1.5 0 0,1 15,12A1.5,1.5 0 0,1 16.5,10.5Z"></path>
                </svg>
            </div>
            <h2>PANEL ADMINISTRACYJNY</h2>
        </div>
        <div class="panel-content">
            <div class="user-management">
                <div>
                    <h3>Dodaj nowego użytkownika</h3>
                    <form action="/admin-panel/add-user" method="post" class="user-form">
                        <input type="text" name="username" placeholder="Nazwa użytkownika" required class="cyber-input">
                        <input type="password" name="password" placeholder="Hasło" required class="cyber-input">
                        <select name="role" class="cyber-input">
                            <option th:each="role : ${roles}" th:value="${role.name}" th:text="${role.name}"></option>
                        </select>
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <button type="submit" class="cyber-button">Dodaj użytkownika</button>
                    </form>
                </div>

                <div>
                    <h3>Dodaj nową rolę</h3>
                    <form action="/admin-panel/add-role" method="post" class="user-form">
                        <input type="text" name="roleName" placeholder="Nazwa roli" required class="cyber-input">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <button type="submit" class="cyber-button">Dodaj rolę</button>
                    </form>
                </div>

                <div class="user-list">
                    <h3>Lista użytkowników</h3>
                    <table>
                        <thead>
                        <tr>
                            <th>Nazwa użytkownika</th>
                            <th>Role</th>
                            <th>Zmień hasło</th>
                            <th>Usuń</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="user : ${users}">
                            <td th:text="${user.username}"></td>
                            <td>
                                <form th:action="@{/admin-panel/update-roles}" method="post">
                                    <input type="hidden" name="userId" th:value="${user.uuid}">
                                    <select name="newRoles" multiple class="cyber-input">
                                        <option th:each="role : ${roles}" th:value="${role.name}" th:text="${role.name}" th:selected="${user.roles.contains(role)}"></option>
                                    </select>
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                    <button type="submit" class="cyber-button-small">Zmień role</button>
                                </form>
                            </td>
                            <td>
                                <form th:action="@{/admin-panel/update-password}" method="post">
                                    <input type="hidden" name="userId" th:value="${user.uuid}">
                                    <input type="password" name="newPassword" placeholder="Nowe hasło" required class="cyber-input">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                    <button type="submit" class="cyber-button-small">Zmień hasło</button>
                                </form>
                            </td>
                            <td>
                                <form th:action="@{/admin-panel/delete-user}" method="post">
                                    <input type="hidden" name="userId" th:value="${user.uuid}">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                    <button type="submit" class="cyber-button-small" style="background-color: var(--danger-red); box-shadow: 0 0 5px var(--danger-red);">Usuń</button>
                                </form>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <div class="channel-management">
                    <h3>Dodaj nowy kanał</h3>
                    <form action="/admin-panel/add-channel" method="post" class="user-form">
                        <input type="text" name="channelName" placeholder="Nazwa kanału" required class="cyber-input">
                        <textarea name="systemPrompt" placeholder="System Prompt (instrukcje dla AI)" rows="5" class="cyber-input"></textarea>
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <button type="submit" class="cyber-button">Dodaj kanał</button>
                    </form>

                    <div class="channel-list">
                        <h3>Lista kanałów</h3>
                        <table>
                            <thead>
                            <tr>
                                <th>Nazwa kanału</th>
                                <th>System Prompt</th>
                                <th>Użytkownicy</th>
                                <th>Akcje</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="channel : ${channels}">
                                <td>
                                    <form th:action="@{/admin-panel/update-channel-name}" method="post">
                                        <input type="hidden" name="channelId" th:value="${channel.id}">
                                        <input type="text" name="channelName" th:value="${channel.name}" required class="cyber-input">
                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                        <button type="submit" class="cyber-button-small">Zapisz</button>
                                    </form>
                                </td>
                                <td>
                                    <button
                                            class="cyber-button-small edit-prompt-btn"
                                            th:data-channel-id="${channel.id}">
                                        Edytuj
                                    </button>
                                </td>
                                <td>
                                    <button
                                            class="cyber-button-small manage-users-btn"
                                            th:data-channel-id="${channel.id}"
                                            th:data-channel-name="${channel.name}">
                                        Zarządzaj
                                    </button>
                                </td>
                                <td>
                                    <form th:action="@{/admin-panel/delete-channel}" method="post">
                                        <input type="hidden" name="channelId" th:value="${channel.id}">
                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                        <button type="submit" class="cyber-button-small" style="background-color: var(--danger-red); box-shadow: 0 0 5px var(--danger-red);">Usuń</button>
                                    </form>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

<div class="modal-overlay" id="edit-modal-overlay">
    <div class="notes-modal">
        <h3>Edycja System Prompt</h3>
        <div class="modal-content">
            <form th:action="@{/admin-panel/update-system-prompt}" method="post" id="edit-channel-form">
                <input type="hidden" name="channelId" id="edit-channel-id" />
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <textarea id="edit-system-prompt" name="systemPrompt" class="cyber-textarea"></textarea>
                <div class="modal-buttons">
                    <button type="button" class="cyber-button-small" id="cancel-edit-btn">Anuluj</button>
                    <button type="submit" class="cyber-button-small" style="background-color: var(--neon-blue);">Zapisz</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal-overlay" id="manage-users-modal-overlay">
    <div class="notes-modal">
        <h3 id="modal-title">Zarządzanie użytkownikami dla kanału: <span id="channel-name-in-modal"></span></h3>
        <div class="modal-content">
            <form th:action="@{/admin-panel/assign-users-to-channel}" method="post" id="manage-users-form">
                <input type="hidden" name="channelId" id="manage-channel-id" />
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <div id="users-list-container">
                </div>
                <div class="modal-buttons">
                    <button type="button" class="cyber-button-small" id="cancel-manage-btn">Anuluj</button>
                    <button type="submit" class="cyber-button-small" style="background-color: var(--neon-blue);">Zapisz</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script id="channels-data" type="application/json" th:utext="${channelsJson}"></script>
<script id="users-data" type="application/json" th:utext="${usersJson}"></script>

<script th:src="@{/js/admin.js}"></script>
</body>
</html>